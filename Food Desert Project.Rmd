---
title: "Food Deserts in the United States"
author: "Team B"
date: "7/28/2020"
output: 
  html_document:
   code_folding: hide
   number_sections: true
   toc: yes
   toc_depth: 3
   toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
# use this function to conveniently load libraries and work smoothly with knitting
# can add quietly=T option to the require() function
# the loadPkg function essentially replaced/substituted two functions install.packages() and library() in one step.
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }

# unload/detact package when done using it
unloadPkg = function(pkg, character.only = FALSE) { 
  if(!character.only) { pkg <- as.character(substitute(pkg)) } 
  search_item <- paste("package", pkg,sep = ":") 
  while(search_item %in% search()) { detach(search_item, unload = TRUE, character.only = TRUE) } 
}
```


```{r xkablesummary}
loadPkg("xtable")
loadPkg("kableExtra")
loadPkg("stringi")
loadPkg("leaps")
loadPkg("ggplot2")
loadPkg("ggmap")
loadPkg("ISLR")
loadPkg("faraway")
loadPkg("tigris")
loadPkg("acs")
loadPkg("stringr") 
loadPkg("ggpubr")
loadPkg("dplyr")
loadPkg("leaps")
loadPkg("MASS")

xkabledply = function(modelsmmrytable, title="Table", digits = 4, pos="left", bso="striped", wide=FALSE) { 
  #' Combining base::summary, xtable, and kableExtra, to easily display model summary. 
  #' wrapper for the base::summary function on model objects
  #' Can also use as head for better display
  #' ELo 202004 GWU DATS
  #' version 1.2
  #' @param modelsmmrytable This can be a generic table, a model object such as lm(), or the summary of a model object summary(lm()) 
  #' @param title Title of table. 
  #' @param digits Number of digits to display
  #' @param pos Position of table, c("left","center","right") 
  #' @param bso bootstrap_options = c("basic", "striped", "bordered", "hover", "condensed", "responsive")
  #' @param wide print table in long (FALSE) format or wide (TRUE) format
  #' @return HTML table for display
  #' @examples
  #' library("xtable")
  #' library("kableExtra")
  #' xkabledply( df, title="Table testing", pos="left", bso="hover" )
  #' xkabledply( ISLR::Hitters[1:5,] )
  if (wide) { modelsmmrytable <- t(modelsmmrytable) }
  modelsmmrytable %>%
    xtable() %>% 
    kable(caption = title, digits = digits) %>%
    kable_styling(bootstrap_options = bso, full_width = FALSE, position = pos)
}

xkabledplyhead = function(df, rows=5, title="Head", digits = 4, pos="left", bso="striped") { 
  xkabledply(df[1:rows, ], title, digits, pos, bso, wide=FALSE)
}

xkabledplytail = function(df, rows=5, title="Tail", digits = 4, pos="left", bso="striped") { 
  trows = nrow(df)
  xkabledply(df[ (trows-rows+1) : trows, ], title, digits, pos, bso, wide=FALSE)
}

xkablesummary = function(df, title="Table: Statistics summary.", digits = 4, pos="left", bso="striped") { 
  #' Combining base::summary, xtable, and kableExtra, to easily display numeric variable summary of dataframes. 
  #' ELo 202004 GWU DATS
  #' version 1.2
  #' @param df The dataframe.
  #' @param title Title of table. 
  #' @param digits Number of digits to display
  #' @param pos Position of table, c("left","center","right") 
  #' @param bso bootstrap_options = c("basic", "striped", "bordered", "hover", "condensed", "responsive")
  #' @return The HTML summary table for display, or for knitr to process into other formats 
  #' @examples
  #' xkablesummary( faraway::ozone )
  #' xkablesummary( ISLR::Hitters, title="Five number summary", pos="left", bso="hover"  )
  
  s = summary(df) %>%
    apply( 2, function(x) stringr::str_remove_all(x,c("Min.\\s*:\\s*","1st Qu.\\s*:\\s*","Median\\s*:\\s*","Mean\\s*:\\s*","3rd Qu.\\s*:\\s*","Max.\\s*:\\s*")) ) %>% # replace all leading words
    apply( 2, function(x) stringr::str_trim(x, "right")) # trim trailing spaces left
  
  colnames(s) <- stringr::str_trim(colnames(s))
  
  if ( dim(s)[1] ==6 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max') 
  } else if ( dim(s)[1] ==7 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max','NA') }
  
  xkabledply(s, title=title, digits = digits, pos=pos, bso=bso )
}

xkablevif = function(model, title="VIFs of the model", digits = 3, pos="left", bso="striped", wide=TRUE) { 
  #' Combining faraway::vif, xtable, and kableExtra, to easily display numeric summary of VIFs for a model. 
  #' ELo 202004 GWU DATS
  #' version 1.2
  #' @param model The lm or compatible model object.
  #' @param title Title of table. 
  #' @param digits Number of digits to display
  #' @param pos Position of table, c("left","center","right") 
  #' @param bso bootstrap_options = c("basic", "striped", "bordered", "hover", "condensed", "responsive")
  #' @param wide print table in long (FALSE) format or wide (TRUE) format
  #' @return The HTML summary table of the VIFs for a model for display, or for knitr to process into other formats 
  #' @examples
  #' xkablevif( lm(Salary~Hits+RBI, data=ISLR::Hitters, wide=T ) )
  
  vifs = table( names(model$coefficients)[2:length(model$coefficients)] ) # remove intercept to set column names
  vifs[] = faraway::vif(model) # set the values
  if (wide) { vifs <- t(vifs) }
  xkabledply( vifs, title=title, digits = digits, pos=pos, bso=bso )
}
```

```{r outlierKD2}
# Fix outliers
# Fix outliers
outlierKD2 <- function(df, var, rm=FALSE) { 
    #' Original outlierKD functino by By Klodian Dhana,
    #' https://www.r-bloggers.com/identify-describe-plot-and-remove-the-outliers-from-the-dataset/
    #' Modified to have third argument for removing outliers inwtead of interactive prompt, 
    #' and after removing outlier, original df will not be changed. The function returns the new df, 
    #' which can be saved as original df name if desired.
    #' Check outliers, and option to remove them, save as a new dataframe. 
    #' @param df The dataframe.
    #' @param var The variable in the dataframe to be checked for outliers
    #' @param rm Boolean. Whether to remove outliers or not.
    #' @return The dataframe with outliers replaced by NA if rm==TRUE, or df if nothing changed
    #' @examples
    #' outlierKD2(mydf, height, FALSE)
    #' mydf = outlierKD2(mydf, height, TRUE)
    #' mydfnew = outlierKD2(mydf, height, TRUE)
    dt = df # duplicate the dataframe for potential alteration
    var_name <- eval(substitute(var),eval(dt))
    na1 <- sum(is.na(var_name))
    m1 <- mean(var_name, na.rm = T)
    par(mfrow=c(2, 2), oma=c(0,0,3,0))
    boxplot(var_name, main="With outliers")
    hist(var_name, main="With outliers", xlab=NA, ylab=NA)
    outlier <- boxplot.stats(var_name)$out
    mo <- mean(outlier)
    var_name <- ifelse(var_name %in% outlier, NA, var_name)
    boxplot(var_name, main="Without outliers")
    hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
    title("Outlier Check", outer=TRUE)
    na2 <- sum(is.na(var_name))
    cat("Outliers identified:", na2 - na1, "\n")
    cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "\n")
    cat("Mean of the outliers:", round(mo, 2), "\n")
    m2 <- mean(var_name, na.rm = T)
    cat("Mean without removing outliers:", round(m1, 2), "\n")
    cat("Mean if we remove outliers:", round(m2, 2), "\n")
    
    # response <- readline(prompt="Do you want to remove outliers and to replace with NA? [yes/no]: ")
    # if(response == "y" | response == "yes"){
    if(rm){
        dt[as.character(substitute(var))] <- invisible(var_name)
        #assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
        cat("Outliers successfully removed", "\n")
        return(invisible(dt))
    } else {
        cat("Nothing changed", "\n")
        return(invisible(df))
    }
}

# sample usage
# mlb2 = outlierKD2(mlb, weight, TRUE) # This will remove weight outliers, replace those values by NA, then save it as a new dataframe mlb2
# mlb = outlierKD2(mlb, weight, TRUE) # This will remove weight outliers, replace those values by NA, then REPLACE the dataframe mlb with the new one.
# outlierKD2(mlb, weight, FALSE) # This will NOT remove weight outliers, but it will show the charts with and without outliers nonetheless. 
# outlierKD2(mlb, weight) # same as above, as the last argument is optional, default = FALSE 
```


# Chapter 1: Introduction 
```{r}
food <- data.frame(read.csv("food.csv"))
food <- subset(food, POP2010 > 1)
food$State<-as.factor(food$State)
food$Region <- as.factor(food$Region)
food$Urban <- as.factor(food$Urban)
colnames(food)[8] <- c("Desert")
str(food)
```

# Chapter 2: Exploratory Data Analysis
### Here we are looking at the normality of our quantitative independent variables to assess whether or not we should exclude outliers when we build our model.
```{r Poverty Rate Normality}
# Poverty Rate Normality of Tracts
hist(food$PovertyRate, main="Histogram of Percentage of Tract at or Below Federal Poverty Rate", xlab="Poverty Rate", col="purple")
qqnorm(food$PovertyRate, main="Q-Q plot of Percentage of Tract at or Below Poverty Rate")
qqline(food$PovertyRate)
outlierKD2(food, PovertyRate, FALSE)
# The Poverty Rate is still slightly skewed to the right with and without outliers and the mean with outliers is about 16% and without outliers it is about 15% so this did not change much.

# Poverty Rate Normality of Tracts in Food Desert 
food.desert <- subset(food, Desert==1)
hist(food.desert$PovertyRate, main="Histogram of the Percentage of Tract at or Below Poverty Rate in a Food Desert", xlab= "Poverty Rate", col="blue")
qqnorm(food.desert$PovertyRate, main="Percentage of Tract in Food Desert at or Below Poverty Rate")
qqline(food.desert$PovertyRate)
outlierKD2(food.desert, PovertyRate, FALSE)
# When we subset our data to only census tracts that are located in food deserts the mean is 26.97 which means about 27% of households located in a food desert   are at or below the federal poverty rate. Furthermore, when we use this subset to take out outliers we only have 36 outliers and the mean changes from 26.97 to 25.42 so there is no signifcant change in removing outliers within this subset. However, within this subset after we move the outliers we can see that our   histogram is more normally distributed. With outliers our distribution is skewed to the right like it is without subsetting the data. 

```

```{r Population Normality }
#Population or POP2010 Normality Test 
summary(food$POP2010)
hist(food$POP2010, main="Histogram of Population in Tract", xlab="Population", col="red")
qqnorm(food$POP2010, main="Q-Q Plot of Tract Population")
qqline(food$POP2010)
# We can tell from our Histogram and Q-Q plot that the distributon of the population is skewed to righly skewed and does not have any since of normality. 

# Population Normality Test of only areas with Food Deserts 
hist(food.desert$POP2010, main="Histogram of Population of Tract in Food Desert", xlab="Population", col="yellow")
qqnorm(food.desert$POP2010, main="Q-Q Plot of Food Desert Population Tract")
qqline(food.desert$POP2010)
summary(food.desert$POP2010)
# When looking at the normality of the population distribution when the tract is located in a food desert the Q-Q plot seems to resemeble more of a straight line but the histogram is still slighly skewed to the right. However, the minimum, maximum, median, and mean values change significanlty when reviewing the population of a tract in a food desert versus not. 

# Finding Outliers
outlierKD2(food, POP2010, rm=FALSE)
outlierKD2(food.desert, POP2010, rm=FALSE)
# When looking at these results we can see that when we remove our outliers the data become significantly more normally distributed even though our mean with outliers is 4,270 and without otuliers the mean is 4,131. This is not a huge different but the because of the drastic shape in our histogram and bellcurve, it might be worth removing the outliers in our population variable. When looking at the outliers in locations that are considered food deserts our mean with outliers is 4,360 and without outliers is 4,254. Though with and without outliers our distribution is slightly skewed to the right it is a bit more noramlly distributed without outliers just like it is in food deserts and non-deserts. 
```

```{r Occupied Housing Normality Test}
hist(food$OHU2010, main="Histogram of Housing Units", xlab="Housing", col="orange")
qqnorm(food$OHU2010, main="Q-Q Plot of Housing Units")
qqline(food$OHU2010)
# When we are looking at our results of the total occupied housing units in the tracts we can see that the data points are righly skewed.  

# Occupied Housing Normality for only food deserts
hist(food.desert$OHU2010, main="Histogram of Housing Units in Food Deserts", xlab="Housing in Food Desert", col="pink")
qqnorm(food.desert$OHU2010, main="Q-Q Plot of Housing in Food Desert")
qqline(food.desert$OHU2010)
# When we are looking at the total occupied housing units in tracts that are classified as food deserts it seems that the distribution is still slightly skewed to the right. However, the Q-Q plot of this data is definetly more normally distributed in the subset of food desert than the whole data frame. 

# Finding Outliers 
outlierKD2(food, OHU2010, rm=FALSE)
outlierKD2(food.desert, OHU2010, rm=FALSE)
# When we look at the outliers of the data frame there are 115 total outliers and the mean with the outliers is 1,615 and without outliers the mean is 1,571 so nothing really changes by removing the outliers. Also, with and without outliers are distribution is skewed to the right. When looking at the outliers in our subset that only incldues tracts in food deserts we can see that there are only 10 outliers. The mean with the outliers is 1,605 and without outliers is 1,579 so nothing really changes by removing the outliers. However, our Q-Q plot of the subset of occupied housing units in food deserts resembles more of a straight line that the data points in the data frame. Nonetheless, the subset's distribution is still rightly-skewed. 
```

```{r Group Housing Normality Test}
summary(food$NUMGQTRS)
hist(food$NUMGQTRS, main="Histogram of Group Housing Units", xlab="Group Housing", col="dark green")
qqnorm(food$NUMGQTRS, main="Q-Q Plot of Group Housing Units")
qqline(food$NUMGQTRS)
# Group Housing units distribution is not normal. It is skewed righ, but barely skewed right. The Q-Q Plot does not even slightly resemeble a straight line. 

# Group Housing Normality for only food deserts
hist(food.desert$NUMGQTRS, main="Histogram of Group Housing Units in Food Deserts", xlab=" Group Housing in Food Desert", col="light blue ")
qqnorm(food.desert$OHU2010, main="Q-Q Plot of Housing in Food Desert")
qqline(food.desert$OHU2010)
# When we take the subset of group hosuing units only located in food deserts the distribution improves a bit more at least with our Q-Q plot. However, the histogram still resembles a right-skewed distribution. 

# Finding Outliers 
outlierKD2(food, NUMGQTRS, rm=FALSE)
outlierKD2(food.desert, NUMGQTRS, rm=FALSE)
# When we look at the group housing outliers in the data frame there are 831. The mean of the data with the outliers is 110 and without the outliers the mean is 24. This is a pretty big drop in the mean than from the other variables that we have seen, but nonetheless the data still has a right-skewed distribution and would yield the same results. When we are looking at the outliers from the subset of group housing units in food deserts the mean also has a big drop. With the outliers the mean is 200 and without outliers the mean is 42. However, the distribution is still right-skewed and would yield the same results. 

```

# Chapter 2.1 Exploratory Data Analysis 
### Here we are performing Chi-Square test on  to determine whether there is a relationship between the categorical variables. 
```{r Categorical Variable Analysis}
# Contigency Table of Food Deserts and Urban Tract
contable.urban <- table(food$Urban, food$Desert)
xkabledply(contable.urban, title="Contingency Table for Food Deserts in Urban Tracts")
urban.tble <- chisq.test(contable.urban)
urban.tble
urban.tble$expected
xkabledply(urban.tble$expected, title="Cross table for the Expected Frequencies of Food Deserts in Urban Tracts")
```

```{r Categorical Variable Analysis}
# Contingency Table of Food Deserts and Geographical Region 
contable.region <- table(food$Region, food$Desert)
xkabledply(contable.region, title="Contingency Table for Food Deserts located in Geographical Regions")
region.tble <- chisq.test(contable.region)
region.tble
region.tble$expected
xkabledply(region.tble$expected, title="Cross table for the Expected Frequencies of Food Deserts in Geographical Regions")
```

```{r Categorical Variable Analysis}
# Contingency Table of Food Deserts and States
contable.state <- table(food$State, food$Desert)
xkabledply(contable.state, title="Contingency Table for Food Deserts located in U.S. States")
state.tble <- chisq.test(contable.state)
state.tble
state.tble$expected
state.tble$p.value
xkabledply(state.tble$expected, title="Cross table for the Expected Frequencies of Food Deserts in U.S. Staes")
```

# Chapter 3: Model Building 
### Here we are disceting which variabels we should use in our model based on Adjusted R-Squared, Cp, BIC, and multicollinearity. 
```{r Using Model Building}
# Deciding Best Varaible with Forward Selection and Subsetting
reg.10.forward <-regsubsets(Desert~.-CensusTract-State, data = food, nvmax=19, nbest=1, method="forward")
plot(reg.10.forward, scale = "adjr2", main = "Adjusted R^2")
plot(reg.10.forward, scale = "Cp", main = "CP")
plot(reg.10.forward, scale = "bic", main = "BIC")

# Backward Selection
reg.best10.bkwd <- regsubsets(Desert~.-CensusTract-State-TractLOWI-TractKids-TractSeniors, data= food, nvmax=10, nbest=1, method="backward")
plot(reg.best10.bkwd, scale = "adjr2", main = "Adjusted R^2")
plot(reg.best10.bkwd, scale = "bic", main = "BIC")
plot(reg.best10.bkwd, scale = "Cp", main = "CP")

# Sequential Selection 
reg.best10.seq <- regsubsets(Desert~CensusTract+State+TractLOWI+TractKids+TractSeniors, data= food, nvmax=10, nbest=1, method="seqrep")
plot(reg.best10.seq, scale = "adjr2", main = "Adjusted R^2")
plot(reg.best10.seq, scale = "Cp", main = "CP")
plot(reg.best10.seq, scale = "bic", main = "BIC")

#Correlation Tests on x variables and y 
cor.test(food$POP2010, food$Desert)
cor.test(food$TractBlack, food$Desert)
cor.test(food$PovertyRate, food$Desert)
cor.test(food$TractSNAP, food$Desert)
```


# Chapter 3.2: Logisitc Regression and Classification 
### Here we are performing a logistical regression and k-NN classifcation test to determine which variables impact whether or not a census tract is located in a food desert. 
```{r}
### Model Building
summary(lm(Desert~.-CensusTract-State,data = food))
glm_1sttry<-glm(Desert~.-CensusTract-State,data = food,family = "binomial")
summary(glm_1sttry)
exp(glm_1sttry$coefficients)
```













